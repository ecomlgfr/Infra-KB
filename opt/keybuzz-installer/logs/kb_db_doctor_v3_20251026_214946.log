â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   KeyBuzz DB Suite Doctor â€“ PgBouncer/HAProxy/Patroni (TCP)
â•‘   no-interactive â€¢ idempotent â€¢ private IPs â€¢ SCRAM+auth_query
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[1;33mINFO[0m Proxies: 10.0.0.11 / 10.0.0.12
[1;33mINFO[0m DBs: 10.0.0.120 / 10.0.0.121 / 10.0.0.122 â€¢ VIP=10.0.0.10  PGB=6432  RW=5432 RO=5433  HC=8008
[0;32mOK[0m Leader: 10.0.0.121
â†’ Patch pg_hba @10.0.0.120
  [0;32mOK[0m reload
â†’ Patch pg_hba @10.0.0.121
  [0;32mOK[0m reload
â†’ Patch pg_hba @10.0.0.122
  [0;32mOK[0m reload
  [0;31mKO[0m cfg invalide
  [0;31mKO[0m cfg invalide
â†’ write pgbouncer.ini + compose @10.0.0.11
  [0;31mKO[0m pgbouncer listen
â†’ write pgbouncer.ini + compose @10.0.0.12
  [0;31mKO[0m pgbouncer listen
â†’ ensure pgbouncer role+secret on leader 10.0.0.121
ERROR:  syntax error at or near "175446"
LINE 1: DO 175446 BEGIN IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE ...
           ^
  [0;31mKO[0m userlist @ 10.0.0.11
  [0;31mKO[0m userlist @ 10.0.0.12
â€” Test client as 'postgres' via 10.0.0.11:6432 â€”
  [1;33mINFO[0m KB_PG_SUPERPASS introuvable dans /opt/keybuzz-installer/credentials/postgres.env ; test sautÃ©.
â€” Test client as 'postgres' via 10.0.0.12:6432 â€”
  [1;33mINFO[0m KB_PG_SUPERPASS introuvable dans /opt/keybuzz-installer/credentials/postgres.env ; test sautÃ©.
â€” Test via LB 10.0.0.10:6432 (client as postgres) â€”
[1;33mINFO[0m Pas de KB_PG_SUPERPASS en env local â€” test LB sautÃ©.

==== RÃ©sumÃ© ====
â€¢ HAProxy locaux: 10.0.0.11:5432/5433/8404 et 10.0.0.12:5432/5433/8404 doivent Ã©couter ([0;32mOK[0m affichÃ©).
â€¢ userlist montÃ© dans les conteneurs PgBouncer ([0;32mOK[0m) et auth_user=pgbouncer + auth_query actifs.
â€¢ pg_hba.conf ouvert pour 10.0.0.0/16 + 172.16.0.0/12 ([0;32mOK[0m).
â€¢ Tests finaux: 'client->PgBouncer->Postgres' sur 10.0.0.11/12 et via VIP 10.0.0.10:6432 doivent rendre '1'.
Log: /opt/keybuzz-installer/logs/kb_db_doctor_v3_20251026_214946.log
