
DÃ©ploiement Vault - Architecture KeyBuzz
Timestamp: 2025-11-08 01:43:35

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 0: VÃ©rifications prÃ©alables                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â†’ Credentials PostgreSQL ... [0;32mOK[0m
â†’ Cluster K3s ... [0;32mOK[0m

Configuration :
  PostgreSQL : 10.0.0.10:5432 (LB â†’ HAProxy â†’ Patroni)
  Port Vault : 8200
  Backend    : PostgreSQL (HA)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 1: PrÃ©paration base PostgreSQL                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CrÃ©ation base et user Vault...
[0;32mOK[0m Connexion PostgreSQL OK
DO
GRANT
You are now connected to database "vault" as user "postgres".
ALTER SCHEMA
GRANT
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
[0;32mOK[0m Base vault crÃ©Ã©e

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 2: CrÃ©ation namespace                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

namespace/vault created
[0;32mOK[0m Namespace vault crÃ©Ã©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 3: CrÃ©ation secrets                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

secret/vault-secrets created
[0;32mOK[0m Secrets Vault crÃ©Ã©s

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 4: DÃ©ploiement Vault DaemonSet                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

configmap/vault-config created
daemonset.apps/vault created
service/vault created
Error from server (BadRequest): error decoding patch: invalid character '\n' in string literal
[0;32mOK[0m Vault DaemonSet dÃ©ployÃ©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 5: CrÃ©ation Ingress                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ingress.networking.k8s.io/vault created
[0;32mOK[0m Ingress vault crÃ©Ã©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 6: Attente dÃ©marrage (60s)                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•â•â• VÃ©rification â•â•â•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Pods Vault :
NAME          READY   STATUS             RESTARTS      AGE   IP           NODE            NOMINATED NODE   READINESS GATES
vault-22vtw   0/1     CrashLoopBackOff   3 (5s ago)    60s   10.0.0.110   k3s-worker-01   <none>           <none>
vault-cz5h2   0/1     CrashLoopBackOff   3 (16s ago)   60s   10.0.0.114   k3s-worker-05   <none>           <none>
vault-kb7b6   0/1     CrashLoopBackOff   3 (15s ago)   60s   10.0.0.101   k3s-master-02   <none>           <none>
vault-pb8st   0/1     CrashLoopBackOff   3 (14s ago)   60s   10.0.0.113   k3s-worker-04   <none>           <none>
vault-sdmjm   0/1     CrashLoopBackOff   3 (15s ago)   60s   10.0.0.100   k3s-master-01   <none>           <none>
vault-slnkp   0/1     CrashLoopBackOff   3 (5s ago)    60s   10.0.0.102   k3s-master-03   <none>           <none>
vault-ww75x   0/1     CrashLoopBackOff   3 (6s ago)    60s   10.0.0.111   k3s-worker-02   <none>           <none>
vault-xcw7m   0/1     CrashLoopBackOff   3 (14s ago)   60s   10.0.0.112   k3s-worker-03   <none>           <none>

Services :
NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
vault   NodePort   10.43.152.140   <none>        8200:30820/TCP,8201:30821/TCP   60s

Ingress :
NAME    CLASS   HOSTS              ADDRESS     PORTS   AGE
vault   nginx   vault.keybuzz.io   localhost   80      61s

DaemonSet :
NAME    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
vault   8         8         0       8            0           <none>          61s


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ… Vault dÃ©ployÃ© avec succÃ¨s                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š Configuration :
  URL externe : http://vault.keybuzz.io
  URL interne : http://vault.vault.svc:8200
  NodePort    : 30820 (HTTP) / 30821 (Cluster)

ğŸ”§ Backend :
  Type        : PostgreSQL (HA)
  Connexion   : 10.0.0.10:5432/vault

âš ï¸  IMPORTANT - Initialisation Vault :

1ï¸âƒ£  Initialiser Vault (PREMIÃˆRE FOIS UNIQUEMENT) :
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator init

  âš ï¸  Sauvegarder les clÃ©s de dÃ©verrouillage et le root token !

2ï¸âƒ£  DÃ©verrouiller Vault (aprÃ¨s chaque redÃ©marrage, 3 clÃ©s minimum) :
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key1>
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key2>
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key3>

3ï¸âƒ£  Se connecter :
  export VAULT_ADDR=http://vault.keybuzz.io
  vault login <root_token>

Prochaine Ã©tape :
  ./13_deploy_monitoring_stack.sh (si pas dÃ©jÃ  fait)
  ./19_deploy_wazuh_siem.sh

