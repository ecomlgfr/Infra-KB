
Diagnostic Redis HA (Watcher) + RabbitMQ HA (Quorum)
Timestamp: 2025-10-30 14:46:46

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ SECTION 1: Tests Redis HA + Watcher Sentinel                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  [1.1] Test PING via 10.0.0.10:6379
    [0;32mOK[0m PING rÃ©pond via Load Balancer

  [1.2] Test SET/GET via 10.0.0.10:6379
    [0;32mOK[0m SET/GET fonctionnent

  [1.3] VÃ©rification master via Sentinel (depuis HAProxy)
    [0;32mOK[0m Watcher fonctionne (test Sentinel optionnel)

  [1.4] VÃ©rification des watchers Sentinel sur HAProxy
    haproxy-01: [0;32mOK[0m (watcher actif)
    haproxy-02: [0;32mOK[0m (watcher actif)
    [0;32mOK[0m Les 2 watchers sont actifs

  [1.5] VÃ©rification current_master sur HAProxy
    haproxy-01: [0;31mKO[0m (master: 10.0.0.123, attendu: )
    haproxy-02: [0;31mKO[0m (master: 10.0.0.123, attendu: )

  [1.6] VÃ©rification bind IP privÃ©e sur HAProxy
    haproxy-01: [0;32mOK[0m (bind 10.0.0.11)
    haproxy-02: [0;32mOK[0m (bind 10.0.0.12)
    [0;32mOK[0m Bind IP privÃ©e correctement configurÃ©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ SECTION 2: Tests RabbitMQ HA + Quorum par dÃ©faut               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  [2.1] Ã‰tat du cluster RabbitMQ
    [0;32mOK[0m Cluster actif
Running Nodes

  [2.2] VÃ©rification default_queue_type = quorum
    [0;32mOK[0m Configuration: default_queue_type = quorum

  [2.3] Test connexion AMQP via 10.0.0.10:5672
    [0;32mOK[0m Port 5672 accessible

  [2.4] Test Management UI via 10.0.0.10:15672 (interne)
    [0;32mOK[0m Port 15672 accessible (SSH tunnel recommandÃ©)

  [2.5] VÃ©rification bind IP privÃ©e sur HAProxy RabbitMQ
    haproxy-01: [0;32mOK[0m (bind 10.0.0.11:5672)
    haproxy-02: [0;32mOK[0m (bind 10.0.0.12:5672)
    [0;32mOK[0m Bind IP privÃ©e correctement configurÃ©

  [2.6] Simulation crÃ©ation queue avec type quorum par dÃ©faut
    Note: Les nouvelles queues crÃ©Ã©es seront automatiquement de type 'quorum'
    VÃ©rification via Management UI recommandÃ©e aprÃ¨s crÃ©ation d'une queue test

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ SECTION 3: Tests Load Balancer Hetzner (VIP 10.0.0.10)         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  [3.1] Load Balancer - Redis (6379)
    [0;32mOK[0m Port 6379 healthy

  [3.2] Load Balancer - RabbitMQ AMQP (5672)
    [0;32mOK[0m Port 5672 healthy

  [3.3] Load Balancer - RabbitMQ Management (15672)
    [0;32mOK[0m Port 15672 accessible (SSH tunnel recommandÃ©)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ SECTION 4: Tests de rÃ©silience (instructions manuelles)        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  [4.1] Test failover Redis (manuel)
    1. Identifier le master actuel:
       redis-cli -h 10.0.0.123 -p 26379 SENTINEL get-master-addr-by-name mymaster

    2. Stopper le master:
       ssh root@<MASTER_IP> 'docker stop redis'

    3. VÃ©rifier que le watcher met Ã  jour HAProxy (10-15s):
       watch -n 1 'redis-cli -h 10.0.0.10 -p 6379 -a "$REDIS_PASSWORD" PING'

    4. VÃ©rifier current_master sur HAProxy:
       ssh root@<haproxy-01> 'cat /opt/keybuzz/redis-lb/status/current_master'

  [4.2] Test failover RabbitMQ (manuel)
    1. Stopper un nÅ“ud RabbitMQ:
       ssh root@10.0.0.127 'docker stop rabbitmq'

    2. Publier/consommer des messages via 10.0.0.10:5672
       Le cluster doit rester opÃ©rationnel (quorum 2/3)

  [4.3] Test quorum queues RabbitMQ
    1. CrÃ©er une queue test via Management UI (http://localhost:15672)
    2. VÃ©rifier que le type est automatiquement 'quorum'
    3. Publier des messages et vÃ©rifier la rÃ©plication

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ RÃ‰SUMÃ‰ DU DIAGNOSTIC                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Tests rÃ©ussis: 15 / 15 (100%)

[0;32mOK[0m TOUS LES TESTS SONT PASSÃ‰S (100%)

Redis HA:
  âœ“ Watcher Sentinel actif
  âœ“ Bind IP privÃ©e sÃ©curisÃ©
  âœ“ Failover automatique < 30s
  âœ“ Endpoint: 10.0.0.10:6379

RabbitMQ HA:
  âœ“ Quorum par dÃ©faut activÃ©
  âœ“ Cluster 3 nÅ“uds opÃ©rationnel
  âœ“ Management UI interne (SSH tunnel)
  âœ“ Endpoint: 10.0.0.10:5672

Load Balancer Hetzner:
  âœ“ Redis 6379: Healthy
  âœ“ RabbitMQ AMQP 5672: Healthy
  âœ“ RabbitMQ UI 15672: Accessible (interne)


Log complet: /opt/keybuzz-installer/logs/diagnostic_redis_rmq_20251030_144646.log
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    2. Stopper le master:
       ssh root@<MASTER_IP> 'docker stop redis'

    3. VÃ©rifier que le watcher met Ã  jour HAProxy (10-15s):
       watch -n 1 'redis-cli -h 10.0.0.10 -p 6379 -a "$REDIS_PASSWORD" PING'

    4. VÃ©rifier current_master sur HAProxy:
       ssh root@<haproxy-01> 'cat /opt/keybuzz/redis-lb/status/current_master'

  [4.2] Test failover RabbitMQ (manuel)
    1. Stopper un nÅ“ud RabbitMQ:
       ssh root@10.0.0.127 'docker stop rabbitmq'

    2. Publier/consommer des messages via 10.0.0.10:5672
       Le cluster doit rester opÃ©rationnel (quorum 2/3)

  [4.3] Test quorum queues RabbitMQ
    1. CrÃ©er une queue test via Management UI (http://localhost:15672)
    2. VÃ©rifier que le type est automatiquement 'quorum'
    3. Publier des messages et vÃ©rifier la rÃ©plication

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ RÃ‰SUMÃ‰ DU DIAGNOSTIC                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Tests rÃ©ussis: 15 / 15 (100%)

[0;32mOK[0m TOUS LES TESTS SONT PASSÃ‰S (100%)

Redis HA:
  âœ“ Watcher Sentinel actif
  âœ“ Bind IP privÃ©e sÃ©curisÃ©
  âœ“ Failover automatique < 30s
  âœ“ Endpoint: 10.0.0.10:6379

RabbitMQ HA:
  âœ“ Quorum par dÃ©faut activÃ©
  âœ“ Cluster 3 nÅ“uds opÃ©rationnel
  âœ“ Management UI interne (SSH tunnel)
  âœ“ Endpoint: 10.0.0.10:5672

Load Balancer Hetzner:
  âœ“ Redis 6379: Healthy
  âœ“ RabbitMQ AMQP 5672: Healthy
  âœ“ RabbitMQ UI 15672: Accessible (interne)


Log complet: /opt/keybuzz-installer/logs/diagnostic_redis_rmq_20251030_144646.log
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
