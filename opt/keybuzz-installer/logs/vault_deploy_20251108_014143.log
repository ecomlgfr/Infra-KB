
DÃ©ploiement Vault - Architecture KeyBuzz
Timestamp: 2025-11-08 01:41:44

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 0: VÃ©rifications prÃ©alables                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â†’ Credentials PostgreSQL ... [0;32mOK[0m
â†’ Cluster K3s ... [0;32mOK[0m

Configuration :
  PostgreSQL : 10.0.0.10:5432 (LB â†’ HAProxy â†’ Patroni)
  Port Vault : 8200
  Backend    : PostgreSQL (HA)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 1: PrÃ©paration base PostgreSQL                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CrÃ©ation base et user Vault...
[0;32mOK[0m Connexion PostgreSQL OK
DO
GRANT
You are now connected to database "vault" as user "postgres".
ALTER SCHEMA
GRANT
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
ALTER DEFAULT PRIVILEGES
[0;32mOK[0m Base vault crÃ©Ã©e

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 2: CrÃ©ation namespace                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[0;32mOK[0m Namespace vault crÃ©Ã©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 3: CrÃ©ation secrets                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error from server (Forbidden): error when creating "STDIN": secrets "vault-secrets" is forbidden: unable to create new content in namespace vault because it is being terminated
[0;32mOK[0m Secrets Vault crÃ©Ã©s

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 4: DÃ©ploiement Vault DaemonSet                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error from server (Forbidden): error when creating "STDIN": configmaps "vault-config" is forbidden: unable to create new content in namespace vault because it is being terminated
Error from server (Forbidden): error when creating "STDIN": daemonsets.apps "vault" is forbidden: unable to create new content in namespace vault because it is being terminated
Error from server (Forbidden): error when creating "STDIN": services "vault" is forbidden: unable to create new content in namespace vault because it is being terminated
Error from server (NotFound): configmaps "vault-config" not found
Error from server (NotFound): configmaps "vault-config" not found
[0;32mOK[0m Vault DaemonSet dÃ©ployÃ©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 5: CrÃ©ation Ingress                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Error from server (Forbidden): error when creating "STDIN": ingresses.networking.k8s.io "vault" is forbidden: unable to create new content in namespace vault because it is being terminated
[0;32mOK[0m Ingress vault crÃ©Ã©

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Ã‰TAPE 6: Attente dÃ©marrage (60s)                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•â•â• VÃ©rification â•â•â•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Pods Vault :
No resources found in vault namespace.

Services :
No resources found in vault namespace.

Ingress :
No resources found in vault namespace.

DaemonSet :
No resources found in vault namespace.


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ… Vault dÃ©ployÃ© avec succÃ¨s                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š Configuration :
  URL externe : http://vault.keybuzz.io
  URL interne : http://vault.vault.svc:8200
  NodePort    : 30820 (HTTP) / 30821 (Cluster)

ğŸ”§ Backend :
  Type        : PostgreSQL (HA)
  Connexion   : 10.0.0.10:5432/vault

âš ï¸  IMPORTANT - Initialisation Vault :

1ï¸âƒ£  Initialiser Vault (PREMIÃˆRE FOIS UNIQUEMENT) :
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator init

  âš ï¸  Sauvegarder les clÃ©s de dÃ©verrouillage et le root token !

2ï¸âƒ£  DÃ©verrouiller Vault (aprÃ¨s chaque redÃ©marrage, 3 clÃ©s minimum) :
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key1>
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key2>
  kubectl exec -n vault $(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}') -- vault operator unseal <key3>

3ï¸âƒ£  Se connecter :
  export VAULT_ADDR=http://vault.keybuzz.io
  vault login <root_token>

Prochaine Ã©tape :
  ./13_deploy_monitoring_stack.sh (si pas dÃ©jÃ  fait)
  ./19_deploy_wazuh_siem.sh

